# 指標

## 概要

メトリックは、ほぼリアルタイムのデータストリームを提供し、システムが実行している機能とその状態についてオペレーターと利害関係者に通知します。ロギングやトレースとは異なり、メトリックデータは送信と保存がより効率的である傾向があります。

## 収集方法

メトリック収集アプローチは、プッシュメトリックとプルメトリックの2つの大きなカテゴリに分類されます。プッシュメトリックは、元のコンポーネントがデータをリモートサービスまたはエージェントに送信することを意味します。[Azure Monitor](https://azure.microsoft.com/en-us/services/monitor)および[Etsyのstatsd](https://github.com/statsd/statsd)は、プッシュメトリックの例です。プッシュメトリックの長所は次のとおりです。

- リモートターゲットへのネットワーク出力のみが必要です。
- 発信コンポーネントは、測定の頻度を制御します。
- コンポーネントはデータの送信先を知るだけでよいため、構成が簡素化されます。

このアプローチとのいくつかのトレードオフ:

- 大規模な場合、データ伝送速度を制御することははるかに困難であり、サービスの抑制や値の低下を引き起こす可能性があります。
- 特に動的スケール環境ですべてのコンポーネントが正常にデータを送信しているのか判断するのが困難です。

プルメトリックの場合、各発信コンポーネントは、メトリックエージェントが接続して測定値を収集するためのエンドポイントを公開します。[Prometheus](https://prometheus.io/)とそのツールのエコシステムは、プルスタイルのメトリックの例です。プルメトリクス設定を使用して経験する利点には、次のものが含まれる場合があります。

- 何を測定するか、およびローカル環境の測定頻度を決定するための特異な構成。
- すべての測定ターゲットには、収集が成功したかどうかに関連するメタメトリックがあり、一般的なヘルスチェックとして使用できます。
- メトリックをグローバルに中央のメトリックストアに送信する前に、メトリックのルーティング、フィルタリング、および処理をサポートします。

一部の人が懸念する項目は次のとおりです。

- データソースの構成と管理は、複雑な構成につながる可能性があります。Prometheusには、Kubernetesなどの一部の環境でデータソースを自動検出して構成するためのツールがありますが、これには常に例外があり、構成が複雑になります。
- 接続を許可するためにファイアウォールやその他のACLを管理する必要がある場合は、ネットワーク構成によってさらに複雑になる可能性があります。

## ベストプラクティス

### ログの代わりにメトリックを使用する必要があるのはいつですか？

[ログとメトリック](../log-vs-metric.md)は、メトリックデータをいつ利用するか、およびログデータをいつ使用するかに関するいくつかの高レベルのガイダンスをカバーしています。どちらも、観察可能なシステムを作成する上で重要な役割を果たします。

### 何を追跡すべきか？

アプリケーション/マシンの状態に関連するシステムクリティカルな測定値。通常、優れたアラート候補です。エンジニアリングおよびDevOpsピアと協力してメトリックを特定しますが、次のものが含まれる場合があります。

- CPUとメモリの使用率。
- リクエストレート。
- キューの長さ。
- 予期しない例外カウント。
- Redisキャッシュ、SQLサーバー、サービスバスの応答時間などの依存するサービスメトリック。

利害関係者への報告を促進する重要なビジネス関連の測定など、コンポーネントのさまざまな利害関係者に相談しますが、いくつかの例には次のものが含まれる場合があります。

- 実行されたジョブ。
- ユーザーセッションの長さ。
- プレイしたゲーム数。
- サイト訪問数。

### 寸法ラベル

今日の最新のメトリックシステムは、通常、単一の時系列メトリックを、メトリックの名前とそのディメンションラベルのディクショナリの組み合わせとして定義します。ラベルは、メトリックの1つのインスタンスを別のインスタンスから区別するための優れた方法ですが、分析のためにセットに対して集計やその他の操作を実行することもできます。指標で使用される一般的なラベルには、次のものがあります。

- コンテナ名
- ホスト名
- コードバージョン
- Kubernetesクラスター名
- Azureリージョン

注：ディメンションラベルは集計およびグループ化操作に使用されるため、ラベルの値として一意の文字列やカーディナリティの高い文字列を使用しないでください。ラベルの値は、レポートのために大幅に減少し、多くの場合、それを追跡するために使用されるメトリックシステムに悪影響を及ぼします。

## 推奨ツール

- [Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/overview) - システムメトリック、ログ分析などを含むサービス群。
- [Prometheus](https://docs.microsoft.com/en-us/azure/azure-monitor/overview) - リアルタイムの監視およびアラートアプリケーション。時系列を公開するための説明形式は、OpenMetricsの標準形式の基礎です。
- [Thanos](https://thanos.io) - 長期保存機能を備えたオープンソースの高可用性Prometheusセットアップ。
- [Cortex](https://cortexmetrics.io) - 水平方向にスケーラブルで可用性が高く、マルチテナントで長期的なPrometheus。
- [Grafana](https://grafana.com) - オープンソースのダッシュボードと視覚化ツール。ログ、メトリクス、分散トレースデータソースをサポートします。
