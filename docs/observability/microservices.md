# マイクロサービスでの可観測性

マイクロサービスは非常に人気のあるソフトウェアアーキテクチャであり、アプリケーションは疎結合サービスのコレクションとして配置されます。これらのサービスの一部は、さまざまなチームによってさまざまな言語で作成できます。

## 動機

可観測性の観点からマイクロサービスアーキテクチャを作成する場合は、特殊なケースを考慮する必要があります。これらのマイクロサービス間でリクエストを行う際の相互作用をキャプチャし、それらを相互に関連付けたいと考えています。

データベースにアクセスしてリクエストの一部としてデータを取得するマイクロサービスがあるとします。このマイクロサービスは、着信httpリクエストまたは実行中の内部プロセスの一部として他の誰かによって呼び出されます。データの取得（またはデータの更新）中に問題が発生した場合はどうなりますか？この特定の呼び出しが宛先マイクロサービスで失敗したことをどのように関連付け、または関連付けることができますか？

これは一般的な問題です。他のマイクロサービスを呼び出す場合、使用するテクノロジースタックによっては、反対側で発生する可能性のあるエラーや例外を誤って非表示にすることがあります。単純なRESTインターフェースを使用している場合、他のマイクロサービスは500 HTTPステータスコードを返す可能性があり、そのマイクロサービス内で何が起こっているのかわかりません。

さらに重要なのは、相関IDをそのマイクロサービス内で発生するものに関連付ける方法がないことです。したがって、特にマイクロサービスアーキテクチャを使用する場合は、トレーサビリティと監視の取り組みを拡張できるように計画を立てることが非常に重要です。

## マイクロサービス間でトレース情報を拡張する方法

W3C コンソーシアムは、マイクロサービスアーキテクチャのプロトコルとして HTTP を使用する場合に適用できる[トレースコンテキスト](https://www.w3.org/TR/trace-context/)定義に取り組んでいます。しかし、この機能をソフトウェアに実装する方法を説明しましょう。

この背後にある主なアイデアは、HTTPリクエスト間の相関情報を伝播して、他のソフトウェアがこの情報を読み取り、マイクロサービス間でテレメトリを正しく相関できるようにすることです。

この情報を伝達する方法は、相関ID、親相関IDなどにHTTPヘッダーを使用することです。

HTTPリクエストの範囲内にいる場合、トレースシステムは、マイクロサービス間で送信するために使用できる4つのプロパティをすでに作成している必要があります。

- RequestId:0HLQV2BC3VP2T:00000001,
- SpanId:da13aa3c6fd9c146,
- TraceId:f11a03e3f078414fa7c0a0ce568c8b5c,
- ParentId:5076c17d0a604244

これは、現在のリクエストを識別する4つのプロパティの例です。

- RequestIdは、現在のHTTPリクエストを表す一意のIDです。
- SSpanIdは、自動的に生成されるデフォルトのスパンです。ソフトウェア内のさまざまな機能を対象とする複数のスパンを持つことができます。
- TraceIdは、現在のログトレースのIDを表します。
- ParentIdは親スパンIDであり、場合によっては同じまたは異なるものになる可能性があります。

## 例

次に、3つのマイクロサービスが連続して相互に呼び出しを行う例を見ていきます。

![image](./microservices.png)

このイメージは、trace-idをAからCに伝播するために各マイクロサービスで必要なものの要約です。

ルート呼び出し元はAであるため、親IDはなく、新しいトレースIDのみがあります。次に、AはHTTPを使用してBを呼び出します。リクエストの一部として相関情報を伝播するために、W3C相関仕様に基づく2つの新しいヘッダー、trace-idとparent-idを使用しています。この例では、Aがルート呼び出し元であるため、Aは独自のトレースIDのみをマイクロサービスBに送信します。

マイクロサービスBは、着信HTTPリクエストを受信すると、これら2つのヘッダーの内容をチェックします。trace-idヘッダーの内容を読み取り、独自の親IDをこのtrace-idに設定します（のB内の緑色の長方形で示されています）。さらに、テレメトリの新しいスコープである信号への新しいtrace-idを作成します。マイクロサービスBの実行中に、マイクロサービスCも呼び出し、パターンを繰り返します。リクエストの一部として、2つのヘッダーが含まれ、trace-idとparent-idも伝播します。

最後に、マイクロサービスCは、着信trace-idの値を読み取り、自分の親IDとして設定しますが、自分の操作に関するテレメトリを送信するために使用する新しいtrace-idも作成します。

## 概要

多くのアプリケーション監視（APM）テクノロジ製品は、すでにこの相関伝搬のほとんどをサポートしています。最も人気のあるのは[OpenZipkin/B3-Propagation](https://github.com/openzipkin/b3-propagation)です。W3Cは、[W3C Trace Context](https://www.w3.org/blog/2019/12/trace-context-enters-proposed-recommendation/)の推奨事項をすでに提案しています。ここでは、どのSDKとフレームワークがすでにこの機能をサポートしているかを確認できます。同じプロジェクトで異なるテクノロジースタックを使用した異なるチームが存在する場合は特に、伝播を正しく実装することが重要です。
