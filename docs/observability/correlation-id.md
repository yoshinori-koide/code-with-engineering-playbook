# 相関ID

## 必要なもの

分散システムアーキテクチャ（マイクロサービスアーキテクチャ）では、さまざまなコンポーネントを介した単一のエンドツーエンドの顧客トランザクションフローを理解することは非常に困難です。

ここにいくつかの一般的な課題があります -

* アプリケーションに入るクライアント要求のエンドツーエンドの動作を理解することは困難になります。
* 集約：複数のコンポーネントからのログを統合し、これらのログを理解することは、不可能ではないにしても、困難です。
* サービスへの循環依存、イベントのコース、非同期リクエストは簡単に解読できません。
* リクエストのトラブルシューティングを行う際、問題の根本を突き止めるには、ログの診断コンテキストが非常に重要です。

## 解決

相関IDは、コンテキストを識別するために最初の対話（着信要求）に追加され、トランザクションフローに関与するすべてのコンポーネントに渡される一意の識別子です。相関IDは、トランザクションを結び付け、イベントの全体像を描くのに役立つ接着剤になります。

>注：独自の相関IDを実装する前に、選択したテレメトリツールが自動生成された相関IDを提供しているかどうか、およびそれがアプリケーションの目的に役立つかどうかを調査してください。たとえば、[Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/auto-collect-dependencies)は、一部のアプリケーションフレームワークの依存関係の自動収集を提供します

### 推奨される方法

1. 各外部リクエストに、メッセージをトランザクションにバインドする相関IDを割り当てます。
2. トランザクションの相関IDは、できるだけ早く割り当てる必要があります。
3. 相関IDをすべてのダウンストリームコンポーネント/サービスに伝達します。
4. トランザクションのすべてのコンポーネント/サービスは、ログでこの相関IDを使用します。
5. HTTPリクエストの場合、相関IDは通常ヘッダーで渡されます。
6. 可能な場合は、送信応答に追加します。
7. ユースケースに基づいて、必要になる可能性のある追加の相関IDが存在する可能性があります。たとえば、セッションIDとユーザーIDの両方に基づく追跡ログが必要になる場合があります。複数の相関IDを追加するときは、それらをコンポーネント全体に伝播することを忘れないでください。

## ユースケース

### ログの相関

ログ相関は、アプリケーションのさまざまな部分を介して異種のイベントを追跡する機能です。相関IDを使用すると、より多くのコンテキストが提供され、レポートと分析のルールを簡単に作成できます。

### 二次報告/オブザーバーシステム

相関IDを使用すると、セカンダリシステムがアプリケーションコンテキストなしでデータを相関させるのに役立ちます。いくつかの例-トレースデータに基づくメトリックの生成、ランタイム/システム診断の統合など。たとえば、AppInsightsデータをフィードし、それをインフラストラクチャの問題に関連付けます。

### エラーのトラブルシューティング

エラーのトラブルシューティングを行う場合、相関IDは、トランザクションのワークフローを追跡するための優れた開始点です。
