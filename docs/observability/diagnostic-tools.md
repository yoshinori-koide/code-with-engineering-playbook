# 診断ツール

[ロギング](pillars/logging.md)、[トレース](pillars/tracing.md)、および[メトリック](pillars/metrics.md)に加えて、アプリケーションが期待どおりに動作しない場合に問題を診断するのに役立つ追加のツールがあります。一部のシナリオでは、メモリ消費量を分析し、特定のプロセスに予想よりも時間がかかる理由を掘り下げるには、追加の対策が必要になる場合があります。このような場合、プラットフォームまたはプログラミング言語固有の診断ツールが機能し、メモリリークのデバッグ、CPU使用率のプロファイリング、またはマルチスレッドの遅延の原因を特定するのに役立ちます。

## プロファイラーとメモリーアナライザー

使用する可能性のある診断ツールには、プロファイラーとメモリアナライザーの2種類があります。

### プロファイリング

プロファイリングは、実行中のアプリケーション内のすべてのスレッドの小さなスナップショットを取得して、指定された期間の各スレッドのスタックトレースを確認する手法です。このツールは、アプリケーションの実行中にCPU時間を費やしている場所を特定するのに役立ちます。これを実現するための主な手法は、CPUサンプリングとインストルメンテーションの2つです。

CPUサンプリングは、設定された間隔ですべてのスタックのスナップショットを取得する非侵襲的な方法です。これはプロファイリングの最も一般的な手法であり、コードを変更する必要はありません。

インストルメンテーションは、各関数の最初と最後に小さなコードを挿入して、関数で費やされた時間、関数名、パラメーターなどについてプロファイラーに通知するもう1つの手法です。このようにして、実行中のアプリケーションのコードを変更します。これには2つの効果があります。コードの実行速度が少し遅くなる可能性がありますが、一方で、アプリケーションでこれまでに実行されたすべての関数とクラスをより正確に表示できます。

#### サンプリングとインストルメンテーションをいつ使用するのですか？

すべてのプログラミング言語がインストルメンテーションをサポートしているわけではありません。インストルメンテーションは、主に.NETやJavaなどのコンパイル言語、およびPythonやJavascriptなどの実行時に解釈される一部の言語でサポートされています。インストルメンテーションを有効にするには、ビルドパイプラインを変更する必要がある場合があります。つまり、コマンドライン引数に特別なパラメーターを追加する必要があります。バイナリを変更する必要がなく、プロセスのパフォーマンスに影響を与えず、より早く開始できるため、通常はサンプリングから開始する必要があります。

プロファイリングデータを取得したら、保存した形式に応じて、この情報を視覚化する方法が複数あります。.NET（dotnet-trace）の例として、これらのトレースを保存するために使用できる3つの形式があります。Chromium、NetTrace、およびSpeedScopeです。使用するツールに応じて、出力形式を選択してください。[SpeedScope](https://www.speedscope.app/)は、トレースの視覚化と分析に使用できるオンラインWebアプリケーションであり、必要なのは最新のブラウザーのみです。ダンプ/トレースには、組織外で共有したくない機密情報が含まれている可能性があるため、オンラインツールには注意してください。

### メモリアナライザ

メモリアナライザとメモリダンプは、プロセスの問題を特定するために使用できるもう1つの診断ツールのセットです。通常、これらのタイプのツールは、プロセスが特定の時点で使用しているメモリ全体を取得し、分析可能なファイルに保存します。これらのタイプのツールを使用するときは、メモリ管理の点で発生する可能性のある欠陥を増幅するために、プロセスに可能な限りストレスをかける必要があります。プロセスがこのストレス状態にあるときに、メモリダンプを取得する必要があります。

一部のシナリオでは、問題の再現中に複数のメモリダンプを取得することをお勧めします。たとえば、メモリリークが疑われ、30分間テストを実行している場合、それらを相互に比較するために、異なる間隔（つまり、10、20、および30分）で少なくとも3つのダンプを取得すると便利です。

使用しているオペレーティングシステムに応じて、メモリダンプを取得する方法は複数あります。また、各オペレーティングシステムには、このメモリダンプをロードし、メモリダンプが取得されたときのプロセスの状態を調べることができる独自のデバッガがあります。

最も一般的なデバッガーは次のとおりです。

- Windows - [WinDbg および WinDgbNext](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools) (Windows SDKに含まれています), [Visual Studio](https://visualstudio.microsoft.com/) は、.NETFrameworkおよび.NETCoreプロセスのメモリダンプをロードすることもできます
- Linux - [GDBはGNUデバッガ](https://www.gnu.org/software/gdb/)です。
- Mac OS - [LLDBデバッガ](https://lldb.llvm.org/)

使用できる開発者プラットフォーム固有の診断ツールには、次のようなものがあります。

- [.NET Core診断ツール](https://docs.microsoft.com/en-us/dotnet/core/diagnostics/#net-core-diagnostic-global-tools), [GitHubリポジトリ](https://github.com/dotnet/diagnostics)
- [Java 診断ツール - バージョン固有](https://docs.oracle.com/en/java/javase/16/troubleshoot/general-java-troubleshooting.html)
- [Python デバッグとプロファイル - バージョン固有](https://docs.python.org/3/library/debug.html)
- [Node.js 診断ワーキンググループ](https://github.com/nodejs/diagnostics)

## プロファイリングのための環境

可能な限り本番環境に近いアプリケーションプロファイルを作成するには、アプリケーションを本番環境で実行する環境を考慮する必要があり、[負荷がかかった](../automated-testing/performance-testing/README.md)状態でアプリケーションの状態のスナップショットを実行する必要がある場合があります。

### コンテナ内の診断

モノリシックアプリケーションの場合、診断ツールをインストールして、それらをホストするVMで実行できます。ほとんどのスケーラブルなアプリケーションは[マイクロサービス](./microservices.md)として開発されており、プロセスを実行するコンテナーにツールをインストールするか、サイドカーコンテナーを活用する必要がある複雑な相互作用があります（[サイドカーパターンを参照](https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar)）。一部のプラットフォームは、エンドポイントを公開してアプリケーションと対話し、ダンプを返します。

便利なリンク：

- [コンテナ内の.NETCore診断](https://docs.microsoft.com/en-us/dotnet/core/diagnostics/diagnostics-in-containers)
- [実験ツール dotnet-monitor](https://devblogs.microsoft.com/dotnet/introducing-dotnet-monitor/)、[What's new](https://devblogs.microsoft.com/dotnet/whats-new-in-dotnet-monitor/)、[GItHubリポジトリ](https://github.com/dotnet/dotnet-monitor/tree/main/documentation)
- [Spring Boot アクチュエーターエンドポイント](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#actuator.endpoints)
