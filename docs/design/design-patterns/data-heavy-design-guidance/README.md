# データとDataOpsの基礎

ほとんどのプロジェクトには、ある種のデータストレージ、データ処理、およびデータ操作が含まれます。これらのプロジェクトでは、すべてのプロジェクトと同様に、セキュリティ、テスト、可観測性、CI/CDなどに関する他のセクションに記載されている一般的なガイドラインに従います。

## ゴール

このセクションの目的は、データ量の多いプロジェクトまたはプロジェクトの一部に基本を適用する方法を簡単に説明することです。

## 隔離

使用している[分離レベル](https://en.wikipedia.org/wiki/Isolation_(database_systems))に注意してください。直列化可能性を提供するデータベースを使用している場合でも、トランザクションまたは接続内で、データベースが提供するよりも低い分離レベルを利用している可能性があります。特に、コミットされていない（または結果整合性）を読み取ると、予測できない多くの副作用が発生し、推論が難しいバグが発生する可能性があります。結果整合性のあるシステムは、スケーラビリティ要件を達成するための最後の手段として扱う必要があります。バッチ処理、シャーディング、およびキャッシングはすべて、スケーラビリティを向上させるために推奨されるソリューションです。これらのオプションのいずれも維持できない場合は、結果整合性に依存するオプションを利用する前に、CockroachDBやTiDBなどの「新しいSQL」データベースを評価することを検討してください。

上記のリンクに記載されている分離レベル以外にも、他のレベルの分離があります。これらのいくつかは、4つの主要なレベルとは異なるニュアンスを持っており、比較するのが難しい場合があります。スナップショットアイソレーション、厳密な直列化可能性、「独自の書き込みを読み取る」、単調な読み取り、制限された古さ、因果整合性、および線形化可能性は、この主題についてさらに学ぶために調べることができる他のすべての用語です。

## 同時実行制御

システムは、競合する要求間の正確性を確保し、データの競合を防ぐために、（ほぼ）常に何らかの形式の同時実行制御を活用する必要があります。並行性制御の2つの形式は、**悲観的**と**楽観的**です。

**悲観的な**トランザクションには、「データをロックする」ための最初の要求と、データを書き込むための2番目の要求が含まれます。これらのリクエストの間に、そのデータにアクセスする他のリクエストは成功しません。詳細については、 [2フェーズロック](https://en.wikipedia.org/wiki/Two-phase_lockin)（2フェーズコミットとも呼ばれます）を参照してください。

（より）推奨されるアプローチは、**楽観的**並行性です。この場合、ユーザーは特定のバージョンでオブジェクトを読み取り、変更されていない場合にのみオブジェクトを更新できます。これは通常、[Etagヘッダー](https://en.wikipedia.org/wiki/HTTP_ETag)を介して行われます。

データベース側でこれを実現する簡単な方法は、更新ごとにバージョン番号をインクリメントすることです。これは、次のように1つの実行されたステートメントで実行できます。

> 警告: 以下は、読み取りがコミットされていない（結果整合性）以下の分離レベルを使用している場合は機能しません。

```SQL
-- Please treat this as pseudo code, and adjust as necessary.

UPDATE <table_name>
SET field1 = value1, ..., fieldN = valueN, version = $new_version
WHERE ID = $id AND version = $version
```

## データ階層化（データ品質）

データセットの品質についての共通の理解を深め、すべての人がデータの品質、および予想されるユースケースと制限を理解できるようにします。

一般的なデータ品質モデルは `ブロンズ`, `シルバー`, `ゴールド`

- **ブロンズ:** れは、データ変換が適用されていないか最小限の生データセットのランディングエリアであるため、書き込み/取り込み用に最適化されています。これらのデータセットを不変として扱い、ストアのみを追加します。
- **シルバー:** これらは、クレンジングされた、半処理されたデータセットです。これらは、既知のスキーマと事前定義されたデータ不変条件に準拠しており、さらにデータ拡張が適用される場合があります。これらは通常、データサイエンティストによって使用されます。
- **ゴールド:** これらは、主にビジネスユーザーの消費のために、高度に処理され、読み取りが最適化されたデータセットです。通常、これらは標準のファクトテーブルとディメンションテーブルで構造化されています。

データレイクを、ブロンズ、シルバー、ゴールドのデータセットを含む3つの主要な領域に分割します。

> 注：ストレージ組織を設計する場合は、不正な形式のデータ、中間（サンドボックス）データ、およびライブラリ/パッケージ/バイナリ用の追加のストレージ領域も役立ちます。

## データ検証

パイプラインの早い段階でデータを検証する

- BronzeデータセットとSilverデータセットの間にデータ検証を追加します。パイプラインの早い段階で検証することにより、すべてのデータセットが特定のスキーマと既知のデータ不変条件に準拠していることを確認できます。これにより、入力データに予期しない変更が加えられた場合に、データパイプラインの障害を防ぐことができる可能性もあります。
- この検証段階に合格しなかったデータは、診断目的で不正な形式のデータ専用のレコードストアに再ルーティングできます。
- データレイクのブロンズエリアに着陸する前に、検証を追加したくなるかもしれません。通常、これはお勧めしません。ブロンズデータセットは、ソースシステムデータのコピーをできるだけ近くに配置するためにあります。これは、テスト（つまり、データ検証ロジックのテスト）とデータ回復の両方の目的でデータパイプラインを再生するために使用できます（つまり、データ変換コードのバグが原因でデータが破損するため、パイプラインを再生する必要があります）。

## べき等データパイプライン

データパイプラインを再生可能でべき等にする

- シルバーとゴールドのデータセットは、意図しないバグ、予期しない入力データの変更など、さまざまな理由で破損する可能性があります。データパイプラインを再生可能でべき等にすることにより、コード修正の展開とデータパイプラインの再再生を通じて、この状態から回復できます。
- べき等性により、データパイプラインを再生するときにデータの重複が軽減されます。

## テスト

データ変換コードがテスト可能であることを確認します

- データアクセスコードからデータ変換コードを抽象化することは、データ変換ロジックに対して単体テストを記述できるようにするための鍵です。この例は、変換コードをノートブックからパッケージに移動することです。
- ノートブックに対してテストを実行することは可能ですが、コードをパッケージに抽出することで、フィードバックサイクルの速度を上げることで、開発者の生産性を向上させることができます。

## CI / CD、ソース管理およびコードレビュー

- データパイプラインを最初から構築するために必要なすべてのアーティファクトは、ソース管理にある必要があります。これには、Infrastructure-as-Codeアーティファクト、データベースオブジェクト（スキーマ定義、関数、ストアドプロシージャなど）、参照/アプリケーションデータ、データパイプライン定義、データ検証および変換ロジックが含まれます。
- リポジトリに導入された新しいアーティファクト（コード）は、自動的に（リンティング、クレデンシャルスキャンなど）、ピアレビューの両方でコードレビューする必要があります。
- 変更を開発、テスト、そして最終的に本番環境に移行するための安全で反復可能なプロセス（CI / CD）が必要です。

## セキュリティと構成

- 特定の環境内の適切なサービスからアクセスできるデータベース接続文字列などの機密性の高い構成のために、中央の安全な場所を維持します。
- Azureでは、これは通常、環境ごとにKey Vaultでシークレットを保護し、関連するサービスにKeyVaultに構成を照会させることで解決されます。

## 可観測性

インフラストラクチャ、パイプライン、データを監視する

- 障害がタイムリーに識別、診断、対処されるように、適切な監視ソリューションを導入する必要があります。基本インフラストラクチャとパイプラインの実行に加えて、データも監視する必要があります。データ監視が必要な一般的な領域は、不正な形式のレコードストアです。

## エンドツーエンドおよびAzureテクノロジーのサンプル

[モダンなデータウェアハウスリポジトリのDataOps](https://github.com/Azure-Samples/modern-data-warehouse-dataops)には、AzureにDataOpsを実装する方法に関するエンドツーエンドのサンプルとテクノロジー固有のサンプルの両方が含まれています。

![CI/CD](images/CI_CD_process.png?raw=true "CI/CD")
画像：Azure上のデータパイプラインのCI/CD-最新のデータウェアハウスリポジトリのDataOpsから
