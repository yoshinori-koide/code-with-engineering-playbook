# フォールトインジェクションテスト

※ オリジナル: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/fault-injection-testing/

フォールトインジェクションテストは、システムの安定性と信頼性を検証および強化するために、システムにエラーと障害を意図的に導入することです。目標は、時間の経過とともに断続的な障害状態での復元力とパフォーマンスに関するシステムの設計を改善することです。

## いつ使用するか

### 対処された問題

システムは、避けられない生産の中断を引き起こした条件に対して回復力がある必要があります。最新のアプリケーションは、依存関係の数が増えて構築されています。インフラストラクチャ、プラットフォーム、ネットワーク、サードパーティのソフトウェアまたはAPIなど。このようなシステムは、依存関係の混乱による影響のリスクを高めます。各依存コンポーネントは失敗する可能性があります。さらに、他のコンポーネントとの相互作用により、障害が伝播する可能性があります。

フォールトインジェクション方式は、開発ライフサイクルの一部として「障害を受け入れる」ことを目的として、ビルド時または実行時に、カバレッジを拡大し、ソフトウェアの堅牢性とエラー処理を検証する方法です。これらの方法は、エンジニアリングチームが障害の設計と継続的な検証、既知および未知の障害状態の説明、冗長性の設計、再試行およびバックオフメカニズムの採用などを支援します。

### 適用可能なのは

* **ソフトウェア** - コードパスの処理エラー、インプロセスメモリ管理。
  * *テストの例:* エッジケースユニット/統合テストおよび/または [負荷テスト](../performance-testing/load-testing.md) (つまり、ストレスとソーク).
* **プロトコル** - コマンドラインパラメータやAPIなどの通信インターフェイスの脆弱性。
  * *テスト例:* [ファジング](https://owasp.org/www-community/Fuzzing) は、コンポーネントのプロトコルの安定性のレベルを評価できる入力として、無効、予期しない、またはランダムなデータを提供します。
* **インフラストラクチャ** - 停止、ネットワークの問題、ハードウェア障害。
  * *テストの例:* さまざまな方法を使用して、仮想マシン（VM）インスタンスのシャットダウン、プロセスのクラッシュ、証明書の期限切れ、ネットワークレイテンシの導入など、基盤となるインフラストラクチャに障害を発生させます。このレベルのテストは、時間の経過に伴う統計メトリックの観察と測定に依存します。障害時に観察された動作の偏差、または回復時間。

## 使い方

### アーキテクチャ

#### 用語

* **Fault/障害** - エラーが判断された、または仮定されたその原因。
* **Error/エラー** - その後の障害を引き起こす可能性のあるシステム状態の部分。
* **Failure/失敗** - 提供されたサービスが正しい状態から逸脱したときに発生するイベント。
* **Fault-Error-Failure cycle/障害-エラー-失敗サイクル** - -[信頼性](https://en.wikipedia.org/wiki/Dependability)の重要なメカニズム：フォールトはエラーを引き起こす可能性があります。エラーが発生すると、システム境界内でさらにエラーが発生する可能性があります。したがって、新しいエラーはそれぞれ障害として機能します。システム境界でエラー状態が観察された場合、それらはFailure/失敗と呼ばれます。(https://en.wikipedia.org/wiki/Dependability)
([Laprie/Aviˇzienis](https://www.nasa.gov/pdf/636745main_day_3-algirdas_avizienis.pdf)によってモデル化されました)

#### フォールトインジェクションテストの基本

フォールトインジェクションは、システムがさまざまな[障害モード](https://en.wikipedia.org/wiki/Failure_mode_and_effects_analysis)にさらされ、リリース検証テストの場合のように、または潜在的な問題を見つけるための調査で、テストエンジニアが期待される結果を事前に知ることができる高度な形式のテストです。製品内で、軽減する必要があります。

#### フォールトインジェクションとカオスエンジニアリング

フォールトインジェクションテストは、1つの条件をテストするための特定のアプローチです。システムの堅牢性を検証するために、システムに障害が発生します。Netflixによって造られたカオスエンジニアリングは、新しい情報を生成するための実践です。懸念事項と用語間のツールには重複があり、多くの場合、カオスエンジニアリングはフォールトインジェクションを使用してシステムに必要な効果を導入します。

### 高レベルのステップバイステップ

#### 開発サイクルでのフォールトインジェクションテスト

フォールトインジェクションはソフトウェアのセキュリティバグを見つける効果的な方法であるため、[Microsoftセキュリティ開発ライフサイクル](https://www.microsoft.com/en-us/securityengineering/sdl/practices)では、コーディングエラーに起因する潜在的な脆弱性を明らかにするために、すべての製品の信頼できないすべてのインターフェイスでファジングを行い、システムに障害を導入することを含む侵入テストを行う必要があります。 、システム構成の障害、またはその他の運用上の展開の弱点。

CIパイプラインの自動フォールトインジェクションカバレッジは、潜在的な問題についてライフサイクルの早い段階でテストするShift-Leftアプローチを促進します。開発ライフサイクル中に[Shift-Left テスト](https://en.wikipedia.org/wiki/Shift-left_testing)アプローチを促進します。
開発ライフサイクル中にフォールトインジェクションを実行する例：

* CIでファジングツールを使用する。
* フォールトインジェクションで強化された既存のエンドツーエンドのシナリオテスト（統合テストやストレステストなど）を実行します。
* 検出されて修正された問題、または解決されたサービスインシデントに基づいて、リグレッションテストと受け入れテストを作成します。
* 新機能のための開発環境での障害のアドホック（手動）検証。

#### リリースサイクルでのフォールトインジェクションテスト

[Synthetic Monitoring Tests](../synthetic-monitoring-tests/README.md)と同様にリリースサイクルでのフォールトインジェクションテストは、実稼働環境または実稼働前環境でテストを実行するために安全な方法を使用する[Shift-Right テスト](https://docs.microsoft.com/en-us/devops/deliver/shift-right-test-production) アプローチの一部です。 分散型のクラウドベースのアプリケーションの性質を考えると、本番環境外のサービスの実際の動作をシミュレートすることは非常に困難です。テスターは、顧客トラフィックのあるライブシステムで、本当に重要な場所でテストを実行することをお勧めします。

フォールトインジェクションテストは、メトリックの可観測性に依存しており、通常は統計的です。次の高レベルの手順は、フォールトインジェクションとカオスエンジニアリングの実践のサンプルを提供します。

* システムの相互運用性の安定した（正常な）状態を測定および定義します。
* 障害モードに基づいて仮説を立てます。
* システムに実際の障害イベントを導入します。
* 状態を測定し、ベースライン状態と比較します。
* プロセスと観察結果を文書化する
* 結果を特定して行動する

## ベストプラクティスとアドバイス

本番環境での実験には、実際のユーザートラフィックを使用してライブシステムに対してテストを実行したり、システムの正常性を確保したり、エラーを適切に処理する能力に自信を持たせたりするという利点があります。本番環境での実験には、実際のユーザートラフィックを使用してライブシステムに対してテストを実行したり、システムの正常性を確保したり、エラーを適切に処理する能力に自信を持たせたりするという利点があります。
テストは成功することも失敗することもあります。障害が発生した場合、本番環境に何らかの影響が及ぶ可能性があります。テストが失敗した場合に、 効果の**ブラスト(爆風)半径**について考えることは、事前に実行する重要なステップです。次の方法は、このようなリスクを最小限に抑えるのに役立つ場合があります。

* 最初に非実稼働環境でテストを実行します。顧客のトラフィックに潜在的なリスクをもたらす前に、合成ワークロードを使用して、システムが安全な環境でどのように動作するかを理解します。
* CDパイプラインを介したさまざまな段階のゲートとしてフォールトインジェクションを使用します。
* ブルー/グリーンおよびカナリアの展開で展開およびテストします。トラフィックシャドウイング (別名 [ダークトラフィック](https://cloud.google.com/blog/products/gcp/cre-life-lessons-what-is-a-dark-launch-and-what-does-it-do-for-me)) などの方法を使用して、顧客のトラフィックをステージングスロットに誘導します。
* できるだけ少ない本番ユーザーに影響を与えながら、実際の結果データを収集することの間のバランスを達成するように努めてください。
* 回路遮断やバルクヘッドパターンなどの防御設計の原則を使用します。
* カオスとフォールトインジェクションへの投資として、予算（サービスレベル目標（SLO）の観点から）について合意しました。
* リスクを段階的に拡大する-コアを強化することから始めて、レイヤーで拡張します。各時点で、進行状況は自動回帰テストで固定する必要があります。

## フォールトインジェクションテストのフレームワークとツール

### Fuzzing

* [OneFuzz](https://github.com/microsoft/onefuzz) - CIパイプラインに簡単に統合できる、Microsoftのオープンソースのセルフホスト型サービスとしてのファジングプラットフォームです。
* [AFL](https://lcamtuf.coredump.cx/afl/)、[WinAFL](https://github.com/googleprojectzero/winafl) - LinuxまたはWindowsのバイナリをターゲットにするためにローカルで使用されるGoogleのプロジェクトゼロチームによって人気のあるファズツール。
* [WebScarab](https://github.com/OWASP/OWASP-WebScarab) - OWASPが所有するWebに焦点を合わせたファザーで、[Kali linux](https://tools.kali.org/web-applications/webscarab) ディストリビューションに含まれます。

### Chaos

* [Chaos toolkit](https://chaostoolkit.org/) - [Azureアクションおよびプローブキット](https://github.com/chaostoolkit-incubator/chaostoolkit-azure)を含む多くの拡張機能を備えた宣言型のモジュラーカオスプラットフォーム。
* [Kraken](https://github.com/openshift-scale/kraken) - Redhatによって保守されているOpenshift固有のカオスツール。
* [Chaos Monkey](https://github.com/netflix/chaosmonkey) - カオスエンジニアリングを普及させたNetflixプラットフォーム（Azure OOTBをサポートしていません）。

## 結論

[カオスの原理](https://principlesofchaos.org/)より: 「定常状態を混乱させるのが難しいほど、システムの動作に対する信頼が高まります。弱点が明らかになった場合、その動作がシステムに現れる前に、改善の目標があります。一般の"。

フォールトインジェクション技術は、出荷する製品の回復力と信頼性を高めます。これらは、顧客に提供される前と提供されている間に、アプリケーションとプラットフォームを検証するために業界全体で使用されます。
フォールトインジェクションは強力なツールであり、注意して使用する必要があります。「ダークローンチ」を意図したコードの展開が原因で発生した[Cloudflareの30分間のグローバル停止](https://blog.cloudflare.com/cloudflare-outage/)などのケースでは、実験中にシステムのブラスト(爆風)半径を縮小することが重要です。

## 参考資料

* [マーク・ルシノビッチのフォールトインジェクションとカオスエンジニアリングのブログ投稿](https://azure.microsoft.com/en-au/blog/advancing-resilience-through-chaos-engineering-and-fault-injection/)
* [CindySridharanの本番ブログ投稿でのテスト](https://medium.com/@copyconstruct/testing-in-production-the-safe-way-18ca102d0ef1)
* [CindySridharanの本番ブログ投稿でのテスト続き。](https://medium.com/@copyconstruct/testing-in-production-the-hard-parts-3f06cefaf592)
* [AzureSearchでのフォールトインジェクション](https://azure.microsoft.com/es-es/blog/inside-azure-search-chaos-engineering/)
* [Azureアーキテクチャフレームワーク-カオスエンジニアリング](https://docs.microsoft.com/en-us/azure/architecture/framework/resiliency/chaos-engineering)
* [Azureアーキテクチャフレームワーク-復元力のテスト](https://docs.microsoft.com/en-us/azure/architecture/framework/resiliency/testing)
* [ソフトウェア障害原因モデルの状況](https://www.researchgate.net/publication/301839557_The_landscape_of_software_failure_cause_models)
