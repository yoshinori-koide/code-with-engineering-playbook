# 消費者主導の契約テスト（CDC）

※ オリジナル: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/cdc-testing/

コンシューマー主導のコントラクトテスト（または略してCDC）は、プロバイダーコンポーネントがコンシューマーコンポーネントの期待と互換性があることを確認しながら、システムのコンポーネントを分離してテストするために使用されるソフトウェアテスト方法です。

## 消費者主導の契約テストを行う理由

CDCは、コンポーネントが相互作用する自動E2Eテストの[いくつかの厄介な欠点](https://pactflow.io/blog/proving-e2e-tests-are-a-scam)を克服しようとします。:

* E2Eテストは遅い
* E2Eテストは簡単に壊れます
* E2Eテストは費用がかかり、保守が困難です
* 大規模なシステムのE2Eテストは、専用のテスト環境の外で実行するのが難しいか不可能な場合があります

以下のテストピラミッドに示されているように、テストのベストプラクティスでは、より安価で高速かつ安定した統合および単体テストと比較して、ほんの数個のE2Eテストを作成することを提案していますが、経験上、[多くのチームがE2Eテストを作成しすぎています](https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html)。この理由は、E2Eテストは、開発者が「実際の」システムをテストしているときに、リリースするための最高の自信を与えるためです。

![E2E Testing Pyramid](./images/testing-pyramid.png)

CDCは、「契約」に文書化された共通の理解に準拠するモックを使用して、コンポーネント間の相互作用を分離してテストすることにより、これらの問題に対処します。コントラクトはコンシューマーとプロバイダーの間で合意され、プロバイダーコンポーネントの実際のインスタンスに対して定期的に検証されます。これにより、大規模なシステムがより小さな部分に効果的に分割され、互いに分離して個別にテストできるため、リリースの自信を与える、よりシンプルで高速かつ安定したテストが実現します。

一部のE2Eテストは、実際の環境に展開したときにシステム全体を検証するために引き続き必要ですが、コンポーネント間のほとんどの機能的な相互作用はCDCテストでカバーできます。

CDCテストは当初RESTfulAPIをテストするために開発されましたが、パターンはすべてのコンシューマープロバイダーシステムに対応し、HTTP以外の他のメッセージングプロトコル用のツールも存在します。

## 消費者主導の契約テスト設計ブロック

 [消費者主導のアプローチ](https://martinfowler.com/articles/consumerDrivenContracts.html)では、消費者は、消費者（クライアント）とプロバイダー（サーバー）の間の契約への変更を推進します。これは直感に反するように聞こえるかもしれませんが、プロバイダーが事前に推測するのではなく、コンシューマーの実際の要件に適合するAPIを作成するのに役立ちます。次に、開発サイクルで発生したCDCビルディングブロックについて説明します。

![CDC testing](./images/cdc-testing.png)

### プロバイダーモックを使用した消費者テスト

コンシューマーは、プロバイダーのモックに対して統合テストを作成し、CIパイプラインの一部として実行することから始めます。期待される応答は、テストから発生した要求のプロバイダーモックで定義されます。これにより、消費者は基本的に、プロバイダーが履行することを期待する契約を定義します。

### 契約

コントラクトは、テスト実行が成功した結果としてプロバイダーモックで定義された期待値から生成されます。[Pact](https://docs.pact.io/)のようなCDCフレームワークは、コンシューマーテストから生成されたリクエスト/レスポンスのリストといくつかの追加のメタデータで構成されるjson形式の [コントラクトの仕様](https://github.com/pact-foundation/pact-specification)を提供します。

契約は、消費者チームとプロバイダーチームの間の話し合いに代わるものではありません。これは、この議論が行われるべき瞬間です（まだ行われていない場合）。消費者テストと生成された契約は、プロバイダーチームのフィードバックと協力によって洗練されています。最後に、完成した契約はバージョン管理され、消費者とプロバイダーの両方がアクセスできる中央の場所に保存されます。

コントラクトは、OpenAPIなどのAPI仕様ドキュメントを補完するものです。API仕様は、APIの構造と形式を記述します。代わりに、コントラクトは、特定の要求に対して、特定の応答が期待されることを指定します。API仕様書は、APIコントラクトの作成に役立ち、コントラクトがAPI仕様に準拠していることを検証するために使用できます。

### プロバイダー契約の検証

プロバイダー側​​では、プロバイダーの実際の応答に対してコントラクトを検証する別のパイプラインの一部としてテストも実行されます。実際の応答が契約で指定されている予想される応答と異なる場合、契約の検証は失敗します。これの原因は次のとおりです。:

1. 現在のプロバイダー実装との非互換性につながるコンシューマー側の無効な期待
2. 一部の機能の欠落またはリグレッションが原因でプロバイダーの実装が壊れている

いずれにせよ、CDCのおかげで、影響を受けるインタラクションのコンシューマー/プロバイダーに至るまで、統合の問題を簡単に特定できます。これは、E2Eテストアプローチで発生した可能性のあるデバッグの問題と比較して、大きな利点です。

## CDCテストフレームワークとツール

[Pact](https://docs.pact.io/)は、[コントラクトの仕様](https://github.com/pact-foundation/pact-specification)を定義しながら、コンシューマーコードベースでの応答のモックとプロバイダーコードベースでの相互作用の検証を可能にするCDCテストの実装です。もともとはRubyで書かれていましたが、複数の言語で利用できるラッパーがあります。Pactは、CDCを使用するときに使用するデファクトスタンダードです。

[Spring Cloud Contract](https://cloud.spring.io/spring-cloud-contract/reference/html)は、SpringのCDCテストの実装であり、Springエコシステムに簡単に統合できます。非Springおよび非JVMプロバイダーとコンシューマーのサポートも存在します。

## 結論

CDCにはいくつかの利点があり、相互作用する複数のコンポーネントで構成されるシステムを扱う場合に検討する価値のあるアプローチになります。

特にコンポーネント間の相互作用の数が増えて複雑になるにつれて、複雑な統合環境を必要とせずに、コンシューマーとプロバイダーの相互作用を個別にテストすることで、メンテナンスの労力を減らすことができます。

![CDC VS E2E tests](./images/cdc-vs-e2e.png)

さらに、CDC開発プロセスを通じて、消費者チームとプロバイダーチーム間の緊密なコラボレーションが強く推奨されます。これにより、他の多くのメリットがもたらされます。コントラクトは、コンポーネントが互いにどのように相互作用するかについての共通の理解を文書化する正式な方法を提供し、チーム間のコミュニケーションの基盤として機能します。ある意味で、コントラクトリポジトリは、システムのすべてのコンシューマーとプロバイダーの相互作用のライブドキュメントとして機能します。

CDCにもいくつかの欠点があります。チームメンバーがCDCを正しく理解して使用するには、教育への適切な投資を必要とするテストの追加レイヤーが追加されます。

さらに、[CDCテストスコープ](https://docs.pact.io/getting_started/testing-scope)は、他のより高いレベルの機能テストレイヤーでCDCがぼやけないように慎重に検討する必要があります。契約テストは、内部のビジネスロジックと消費者の正しさを検証する場所ではありません。

## 参考資料

* "テストのピラミッド"は [Kent C. Dodd’s blog](https://blog.kentcdodds.com/write-tests-not-too-many-mostly-integration-5e8c7fff591c)より
* [Pact](https://docs.pact.io/)、いくつかの異なるプログラミング言語をサポートするコードファーストの消費者主導の契約テストツール
* 消費者主導の契約](https://martinfowler.com/articles/consumerDrivenContracts.html)はイアンロビンソンより
* [契約テスト](https://martinfowler.com/bliki/ContractTest.html)はマーティンファウラーより
* [JavaクライアントサーバーアプリケーションでPactの消費者主導のコントラクトテスト](https://github.com/oottka/pact-spring)を使用する簡単な例
* [Pact .Net ワークショップ](https://github.com/pact-foundation/pact-workshop-dotnet-core-v1)
