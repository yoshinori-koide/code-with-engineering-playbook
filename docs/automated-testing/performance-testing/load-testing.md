# 負荷テスト

※ オリジナル: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/performance-testing/load-testing/

「*負荷テストは、通常のピーク負荷状態と予想されるピーク負荷状態の両方でシステムの動作を判断するために実行されます。*」 - [負荷テスト - Wikipedia](https://en.wikipedia.org/wiki/Load_testing)

負荷テストは、予想される通常のワークロードとピーク時のワークロードの下でシステムがどのように動作するかを判断するように設計されています。具体的には、その主な目的は、システムが予想される負荷レベルを処理できるかどうかを確認することです。ターゲットシステムに応じて、これは同時ユーザー、1秒あたりのリクエスト数、またはデータサイズになります。

## 負荷テストを行う理由

主な目的は、システムを本番環境にリリースする前に、予想される通常の負荷の下でシステムが正常に動作できることを証明することです。「正常に動作する」を定義する基準は、ターゲットによって異なります。これは、「システムは引き続き使用可能」と同じくらい単純な場合がありますが、応答時間のSLAまたはエラー率を満たすことも含まれる場合があります。

さらに、負荷テストの結果は、容量の計画とスケーラビリティの計算に役立つデータとしても使用できます。

## 負荷テストの設計ブロック

負荷テストを実行するために必要な基本的なコンポーネントがいくつかあります。

1. 意味のある結果を得るには、システムを、予想される展開環境に非常によく似たネットワークとハードウェアを備えた本番環境のような環境でテストする必要があります。

2. 負荷テストは、ユーザーアクティビティをシミュレートするモジュールで構成されます。もちろん、この「ユーザーアクティビティ」の構成は、テストするアプリケーションの種類によって異なります。たとえば、eコマースWebサイトは、ユーザーによるアイテムの閲覧と購入をシミュレートしますが、IoTデータ取り込みパイプラインはデバイスの読み取りのストリームをシミュレートします。ボリュームだけでなく、パターンや変動性も考慮して、シミュレーションが実際のアクティビティにできるだけ近いことを確認してください。たとえば、シミュレータデータが均一すぎるか予測可能である場合、キャッシュ/ヒット率が結果に影響を与える可能性があります。

3. 負荷テストは、適用される負荷の量を制御できるターゲットシステムの外部のコンポーネントから開始されます。これは単一のエージェントにすることができますが、より高いレベルのアクティビティを実現するために、複数のエージェントにスケーリングする必要がある場合があります。

4. 負荷テストを実行する必要はありませんが、テストの影響を測定し、潜在的なボトルネックを発見できるように、監視やログ記録を行うことをお勧めします。

## 負荷テストの適用

### 計画

1. **測定する主要なシナリオを特定する**  - プロダクトオーナーからこれらのシナリオを収集し、実際のトラフィックの代表的なサンプルを提供する必要があります。
2. **シナリオの予想される通常の負荷とピーク負荷を決定する** - 実行する負荷テストのサイズを見つけるために、同時ユーザーや1秒あたりの要求などの負荷レベルを決定します。
3. **成功基準のメトリックを特定する** - これらは、応答時間やエラー率などのテスト側にある場合もあれば、CPUやメモリ使用量などのシステム側にある場合もあります。
4. **適切なツールを選択する** - 負荷テストには多くのフレームワークが存在するため、機能と制限がニーズに適しているかどうかを検討してください。（いくつかの人気のあるツールを以下に示します）。

### 実行

既存のテストフレームワークを使用することをお勧めします（以下を参照）。これらのツールは、ユーザーアクティビティシナリオを指定する方法と、ロード時にそれらを実行する方法の両方を提供します。実際の動作をより適切に再現するために、目的の負荷までゆっくりとランプアップするのが一般的です。定義したワークロードに達したら、システムが安定するかどうかを確認するのに十分な時間、このレベルを維持します。テストを終了するには、システムの速度がどのように低下​​するかを記録するためにランプを設定する必要もあります。

また、負荷テストトラフィックの発信元も考慮する必要があります。ターゲットシステムのスコープによっては、別の場所から開始して、別の地域などからの実際のトラフィックをより適切に複製することができます。

**注：** 開始する前に、ネットワーク管理者に通知したり、免除を申請したりする必要があるDDOS保護など、ネットワークの制限に注意してください。

### さらなるテスト

負荷テストを完了したら、次のような追加の関連テストに進むように設定する必要があります。

- **ソークテスト** - **耐久性テスト**とも呼ばれます。長期間の安定性を確保するために、長期間にわたって負荷テストを実行します。
- **ストレステスト** - 負荷を徐々に増やして、システムの限界を見つけ、最大容量を特定します。
- **スパイクテスト** - 負荷シナリオに短期間の急激な増加を導入します。
- **スケーラビリティテスト** - システムがどのようにスケーリングするかを測定するために、水平方向または垂直方向に拡張するときにシステムを再テストします。

## 負荷テストのフレームワークとツール

検討できる一般的な負荷テストフレームワークと、シナリオの定義に使用される言語を次に示します。

- **JMeter** (<https://github.com/apache/jmeter>) - コーディングせずにテストするためのパターンが組み込まれていますが、Javaで拡張できます。
- **Artillery** (<https://artillery.io/>) - シナリオをJavascriptで記述し、ノードアプリケーションを実行します。
- **Gatling** (<https://gatling.io/>) - DSLを使用してScalaでシナリオを記述します。
- **Locust** (<https://locust.io/>) - 同時ユーザーアクティビティの概念を使用して、Pythonでシナリオを記述します。
- **K6** (<https://k6.io/>) - オープンソースまたはSaaSとして利用可能なJavascriptでテストシナリオを記述します。
- **NBomber** (<https://nbomber.com/>) - テストシナリオをC＃またはF＃で記述し、テストランナー（NUnit / xUnit）と統合できます。

## 結論

負荷テストは、ターゲットシステムが予想される実際のトラフィックの下で信頼できるかどうかを理解するための重要なステップです。

もちろん、予想される負荷を予測する能力と同じくらい優れているため、さまざまな状況でシステムがどのように動作するかを真に理解するために、他のさらなるテストをフォローアップすることが重要です。

## 参考資料

さらに深く掘り下げたい人のために、このテストタイプに関する追加の読み物をリストしてください。

- [MicrosoftAzure適切に設計されたフレームワーク>負荷テスト](https://docs.microsoft.com/en-us/azure/architecture/framework/scalability/load-testing)
