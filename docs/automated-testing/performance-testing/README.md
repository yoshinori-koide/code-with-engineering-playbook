# 性能試験

※ オリジナル: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/performance-testing/

パフォーマンステストは、パフォーマンス関連のテストのいくつかのサブカテゴリを指すために使用される過負荷の用語であり、それぞれが異なる目的を持っています。

全体的なパフォーマンステストの適切な説明は次のとおりです。

> パフォーマンステストは、特定のワークロードでのシステムの応答性、スループット、信頼性、および/またはスケーラビリティを判断することを目的としたテストの一種です。[Webアプリケーションのパフォーマンステストガイダンス](https://docs.microsoft.com/en-us/archive/blogs/dajung/ebook-pnp-performance-testing-guidance-for-web-applications).

パフォーマンステストのさまざまなサブカテゴリに入る前に、パフォーマンステストが通常行われる理由を理解しましょう。

## パフォーマンステストを行う理由

パフォーマンステストは通常​​、次の1つ以上を達成するために実施されます。

- **システムのパフォーマンスを調整する**

  - さまざまな負荷レベルでのシステムのボトルネックと問題を特定します。

  - さまざまなシステム構成のシステムのパフォーマンス特性を比較します。

  - システムのスケーリング戦略を考え出します。

- **キャパシティプランニング**を支援する

  - キャパシティプランニングは、事前定義されたパフォーマンス目標をサポートするためにアプリケーションを実行するために必要なハードウェアおよびソフトウェアリソースのタイプを決定するプロセスです。

  - キャパシティプランニングには、ハードウェアおよびソフトウェアインフラストラクチャの実行コストを考慮して、ビジネスの期待、アプリケーション使用量の定期的な変動を特定することが含まれます。

- リリースに向けた**システムの準備状況** の評価
  
  - 本番環境のような環境でのシステムのパフォーマンス特性（応答時間、スループット）の評価。目標は、リリース時にパフォーマンスの目標を確実に達成できるようにすることです。

- **アプリケーションの変更によるパフォーマンスへの影響** の評価

  - 以前の実行中のパフォーマンス特性の値（またはベースライン値）を変更した後のアプリケーションのパフォーマンス特性を比較すると、パフォーマンスの問題（パフォーマンスの低下）または変更によって導入された拡張機能を示すことができます。
  
## 主要なパフォーマンステストのカテゴリ

パフォーマンステストは幅広いトピックです。テストを実行できる領域はたくさんあります。広いストロークでは、バックエンドとフロントエンドでテストを実行できます。個々のコンポーネントのパフォーマンスをテストするだけでなく、エンドツーエンドの機能をテストすることもできます。

テストにはいくつかのカテゴリもあります。

### [負荷テスト](./load-testing.md)

これは、システムが実稼働中に予想される負荷量に直面したときに、システムのパフォーマンス特性を検証することに焦点を当てたパフォーマンステストのサブカテゴリです。**耐久性テスト** もしくは**ソークテスト** は、数時間から数日にわたる長期間にわたって実施される負荷テストです。

### ストレステスト

これは、システムが極端な負荷に直面したときにシステムのパフォーマンス特性を検証することに焦点を当てたパフォーマンステストのサブカテゴリです。目標は、システムが限界までのプレッシャーにどのように対処するか、回復するか（つまり、スケールアウトするか）、または単に壊れて失敗するかを評価することです。

### 耐久性試験

耐久性テストの目標は、システムが長期間の負荷の下で良好なパフォーマンスを維持できることを確認することです。

### スパイクテスト

スパイクテストの目標は、ソフトウェアシステムが大規模で突然の大波に適切に応答できることを検証することです。

### カオステスト

カオステストまたはカオスエンジニアリングは、システムが生産中の乱流条件に耐えることができるという確信を構築するために、システムで実験する方法です。その目標は、システム全体に現れる前に弱点を特定することです。開発者は、サービス障害のフォールバック手順を実装することがよくあります。カオステストは、フォールバック手順が正しく機能することを検証するために、システムのさまざまな部分を任意にシャットダウンします。

## パフォーマンスモニターのメトリック

パフォーマンスモニターのメトリック

基本的なハードウェアレベルでは、考慮すべき4つの領域があります。

- 物理ディスク
- メモリー
- プロセッサー
- 通信網

これらの4つの領域は密接に関連しています。つまり、ある領域でパフォーマンスが低下すると、別の領域でパフォーマンスが低下します。アプリケーションのパフォーマンスの理解に関心のあるエンジニアは、これら4つのコア領域に焦点を当てる必要があります。

ある領域のパフォーマンスが別の領域のパフォーマンスにどのように影響するかを示す典型的な例は、メモリの負荷です。

アプリケーションの使用可能なメモリが不足している場合、オペレーティングシステムは、データのページをメモリからディスクに転送してメモリを解放することにより、メモリの不足を補おうとします。ただし、この作業にはCPUと物理ディスクの支援が必要です。

つまり、メモリの量が少ない場合のパフォーマンスを見ると、CPUだけでなくディスクアクティビティも急上昇していることがわかります。

## 物理ディスク

ほとんどすべてのソフトウェアシステムは、物理ディスクのパフォーマンスに依存しています。これは、データベースのパフォーマンスに特に当てはまります。物理ディスクストレージにSSDを使用するための最新のアプローチにより、アプリケーションのパフォーマンスを劇的に向上させることができます。キャプチャして分析できるメトリックの一部を次に示します。

| Counter | Description  |
|:-------------------- |:--------------------  |
| 平均 ディスクキューの長さ | この値は、（Disk Transfers / sec）*（Disk sec / Transfer）カウンターを使用して算出されます。このメトリックは、時間の経過に伴うディスクキューを表し、急激なスパイクを滑らかにします。平均キュー長が2を超える物理ディスクを長期間使用している場合は、ディスクがボトルネックになっている可能性があります。 |
| ％ アイドルタイム | これは、ディスクがアイドル状態だった時間の割合の尺度です。すなわち。完了するのを待っているオペレーティングシステムからの保留中のディスク要求はありません。ここでの低い数値は、ディスクにオペレーティングシステムからの要求を処理または書き込むための過剰な容量があることを示す肯定的な兆候です。 |
| 平均 ディスク秒/読み取りおよび平均 ディスク秒/書き込み | これらは両方とも、ディスクの遅延を測定します。遅延は、ディスク転送が完了するまでにかかる平均時間として定義されます。明らかに必要なのは可能な限り少ない数値ですが、SSDと従来の回転ディスクの固有の速度の違いを考慮する必要があります。このカウンターでは、ハードウェアのインストール後にベースラインを定義することが重要です。次に、この値を使用して、ハードウェアに関連する遅延の問題が発生しているかどうかを判断します。  |
| ディスク読み取り/秒およびディスク書き込み/秒 | これらのカウンターはそれぞれ、1秒あたりに完了したIO要求の総数を測定します。レイテンシーカウンターと同様に、これらのカウンターの良い値と悪い値はディスクハードウェアによって異なりますが、この場合、通常、初期ベースラインよりも高い値はハードウェアの問題を示していません。このカウンターは、ディスクI/Oのスパイクを識別するのに役立ちます。  |

## プロセッサー

カーネルモードまたは特権モードで費やされた時間を理解することが重要です。一般に、コードがオペレーティングシステムコールの実行に多くの時間を費やしている場合、データベース、Webサーバー/サービスなどのユーザーモードアプリケーションを実行できないため、これは懸念事項となる可能性があります。

ガイドラインでは、CPUはカーネルモードで実行されている合計プロセッサ時間の約20％のみを費やす必要があります。

| Counter | Description  |
|:-------------------- |:--------------------  |
| ％プロセッサ時間 | これは、プロセッサが実行でビジー状態だった合計経過時間のパーセンテージです。このカウンターは高すぎるか低すぎる可能性があります。プロセッサ時間が常に40％を下回っている場合は、CPUをオーバープロビジョニングしたかどうかについて疑問があります。70％は一般に適切な目標数と見なされ、70％を超え始めた場合は、CPUの負荷が高い理由を調査することをお勧めします。|
| ％特権（カーネルモード）時間 | これは、プロセッサがカーネルモードでの実行に費やした経過時間のパーセンテージを測定します。このカウンターはカーネル操作のみを考慮しているため、特権時間の割合が高い（25％を超える）場合は、調査が必要なドライバーまたはハードウェアの問題を示している可能性があります。 |
| ％ユーザー時間 | プロセッサがユーザーモード（アプリケーションコード）での実行に費やした経過時間の割合。上記のカーネル操作と、他のアプリケーションで必要なCPUのその他のバーストの両方にある程度のバッファーが必要なため、適切なガイドラインは常に65％未満にすることです。 |
| キューの長さ | これは、実行の準備ができているが、コアが使用可能になるのを待っているスレッドの数です。シングルコアマシンでは、2〜3を超える持続値は、CPUにある程度の負荷がかかっていることを意味する場合があります。同様に、マルチコアマシンの場合、キューの長さをコアの数で割ります。それが継続的に2〜3を超える場合は、CPUに負荷がかかる可能性があります。 |

## ネットワークアダプター

多くの場合、ネットワーク速度はパフォーマンス低下の隠れた原因です。多くの場合、ネットワークパフォーマンスの低下の根本原因を見つけることは困難です。問題の原因は、ビデオ会議、トランザクションデータ、ネットワークバックアップ、レクリエーションビデオなどの帯域幅の浪費に起因する可能性があります。

実際、ネットワークの速度が低下する最も一般的な3つの理由は次のとおりです。

- 混雑
- データの破損
- 衝突

役立つツールには、次のものがあります。:

- ifconfig
- netstat
- iperf
- tcpretrans
- tcpdump
- WireShark

ネットワークパフォーマンスのトラブルシューティングは通常、ハードウェアのチェックから始まります。調査する典型的なことは、配線が緩んでいないかどうか、またはすべてのルーターの電源が入っていることを確認することです。常にそうすることが可能であるとは限りませんが、モデムまたはルーターのパワーリサイクルの単純なケースで多くの問題を解決できる場合があります。

ネットワークスペシャリストは、多くの場合、次の一連のトラブルシューティング手順を実行します。

- ハードウェアを確認してください
- ipconfigを使用する
- pingとtracertを使用する
- DNSチェックを実行する

以下で説明するように、より高度なアプローチでは、多くの場合、ネットワークパフォーマンスカウンターのいくつかを調べる必要があります。

### ネットワークカウンター

上記の表は、ネットワークに期待できることをよりよく理解するためのいくつかの参照ポイントを示しています。ボトルネックが存在する可能性のある場所を理解するのに役立ついくつかのカウンターを次に示します。

| カウンター | 説明  |
|:-------------------- |:--------------------  |
| 受信バイト数/秒 | 各ネットワークアダプタを介してバイトが受信される速度。  |
| 送信バイト数/秒 | 各ネットワークアダプタを介してバイトが送信される速度。 |
| 合計バイト数/秒 | ネットワークを介して送受信されたバイト数。 |
| 受信したセグメント/秒 | プロトコルでセグメントが受信されるレート |
| 送信されたセグメント/秒 | セグメントが送信されるレート。 |
| ％割り込み時間 | プロセッサがハードウェア割り込みの受信とサービスに費やす時間の割合。この値は、ネットワークアダプターなど、割り込みを生成するデバイスのアクティビティの間接的な指標です。 |

> **レイテンシ/遅延** と **スループット**には重要な違いがあります。**レイテンシ/遅延**は、パケットがネットワークを介して転送されるのにかかる時間を、一方向の送信または往復の送信のいずれかで測定します。**スループット**は異なり、単位時間内に送受信されるデータの量を測定しようとします。

## メモリー

| カウンター | 説明  |
|:-------------------- |:--------------------  |
| 利用可能 MB | このカウンターは、実行中のアプリケーションが使用できるメモリの量を表します。メモリが少ないとページフォールトが発生する可能性があります。これにより、ディスクとの間でメモリを交換するためにCPUに追加の圧力がかかります。使用可能なメモリの量が10％を下回る場合は、より多くのメモリを取得する必要があります。 |
| ページ/秒 | これは、実際には「ページ入力/秒」と「ページ出力/秒」カウンターの合計であり、ページフォールトの結果としてページが読み書きされる速度です。この値の小さなスパイクは問題があることを意味しませんが、50を超える持続値は、システムメモリがボトルネックであることを意味する可能性があります。 |
| ページングファイル（_Total）\％使用量 | 現在使用されているシステムページファイルの割合。これはパフォーマンスとは直接関係ありませんが、ページファイルが完全にいっぱいになり、アプリケーションから追加のメモリが要求されている場合は、アプリケーションで重大な問題が発生する可能性があります。 |

## 主要なパフォーマンステスト活動

パフォーマンステストのアクティビティは、パフォーマンステストのサブカテゴリとシステムの要件および制約によって異なります。具体的なガイダンスについては、上記のパフォーマンステストのサブカテゴリへのリンクをたどることができます。パフォーマンステストのサブカテゴリによっては、次のアクティビティが含まれる場合があります。

### テストの合格基準を特定する

これには通常、システムのパフォーマンス特性の目標と制約を特定することが含まれます

### テストの計画と設計

一般に、次の点を考慮する必要があります。

- アプリケーションをテストする必要がある負荷の定義

- 収集するメトリックを確立する

- テストに使用するツールを確立します

- パフォーマンステストの頻度を確立します。パフォーマンステストを機能開発スプリントの一部として実行するのか、それとも主要な環境にリリースする前にのみ実行するのか。

### 実装

- 設計されたアプローチに従ってパフォーマンステストを実装します。

- システムをインストルメント化し、必要なパフォーマンスメトリックを放出していることを確認します。

### テストの実行

- テストを実行し、パフォーマンスメトリックを収集します。

### 結果の分析と再テスト

- テストの結果/パフォーマンスメトリックを分析します。

- テストの目的によりよく対応するために、システム（つまり、コード、インフラストラクチャ）を微調整するために必要な変更を特定します。

- その後、もう一度テストします。このサイクルは、テストの目的が達成されるまで続きます。

[Iterative/反復パフォーマンステストテンプレート](./iterative-perf-test-template.md)を使用して、反復ごとのテスト結果に関する詳細をキャプチャできます。

## 参考資料

- [パターンと実践：Webアプリケーションのパフォーマンステストガイダンス](https://docs.microsoft.com/en-us/archive/blogs/dajung/ebook-pnp-performance-testing-guidance-for-web-applications)
