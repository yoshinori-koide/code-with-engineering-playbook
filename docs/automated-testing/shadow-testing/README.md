# シャドウテスト

※ オリジナル: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/shadow-testing/

シャドウテストは、本番環境に移行する前にリスクを軽減するための1つのアプローチです。シャドウテストは、「ShadowDeployment」または「ShadowingTraffic」とも呼ばれ、「Darklaunching」との類似点です。

## いつ使用するか

シャドウテストは、現在の環境（V-Current）を新しい機能を備えた候補環境（V-Next）に置き換えることを検討する場合のリスクを軽減します。このアプローチは、2つの環境間の違いを監視およびキャプチャし、新しい機能/リリースを導入する前にすべてのリスクを比較して削減します。

私たちのテストケースでは、コードカバレッジは非常に重要ですが、実際の組み合わせや可能性を再現するには、コードカバレッジを提供するのが難しい場合があります。このアプローチでは、並べて展開しているV-Next環境をテストするために、同じトラフィックをV-Current環境で複製し、同じトラフィックをV-Next環境に転送します。唯一の違いは、応答が返されないことです。 V-Next環境からユーザーへ。ただし、V-Currentの応答と比較するために、これらの応答を収集します。

![Shadow Testing Overview](images/shadow-testing.png)

 [カオスエンジニアリング](https://principlesofchaos.org/)の原則の1つを参照して、以下のように実際のトラフィックをサンプリングすることの重要性について言及します。

> システムは、環境とトラフィックパターンに応じて異なる動作をします。使用率の動作はいつでも変更される可能性があるため、実際のトラフィックをサンプリングすることが、要求パスを確実にキャプチャする唯一の方法です。システムの実行方法の信頼性と現在展開されているシステムとの関連性の両方を保証するために、Chaosは本番トラフィックで直接実験することを強く望んでいます。

このシャドウテストのアプローチでは、V-Next環境での実際の顧客の行動を活用して、実際のトラフィックをサンプリングし、ユーザーが本番環境で直面する可能性のあるリスクを軽減します。同時に、実際にサンプリングされたトラフィックでスケーリングするために、V-Next環境インフラストラクチャをテストしています。V-Nextは、V-Currentと同じ方法でスケーリングする必要があります。製品の実際の動作をテストしていますが、トラフィックはV-next環境に複製されるため、これにより本番環境に影響を与えずに新機能をテストできます。

[Dark Launching](https://martinfowler.com/bliki/DarkLaunching.html)にはいくつかの類似点があり、Dark Launchingは新機能を製品コードに統合することを提案していますが、ユーザーはその機能を使用できません。バックエンドでは、機能をテストして、許容できるまでパフォーマンスを向上させることができます。[フィーチャートグル](https://martinfowler.com/bliki/FeatureToggle.html)にも似ています。このアプローチを使用すると、新しい機能がユーザーに表示され、フィードバックを収集できます。フィーチャートグルでダークローンチを使用すると、新しい機能を導入するのに非常に役立ちます。

## 適用可能

- **本番環境への展開**: V-Next in Shadowテストは常に個別に機能し、本番環境には影響しません。ユーザーはこのテストの影響を受けません。
- **インフラストラクチャ**: 同じトラフィックを複製するシャドウテスト。テスト環境では、本番環境で同じトラフィックを使用できます。実際のテストシナリオを作成するのに役立ちます
- **スケールの処理**: すべてのトラフィックが複製され、システムのスケーリングを確認する機会があります。

## シャドウテストのフレームワークとツール

シャドウテストを実装するためのツールがいくつかあります。これらのツールの主な目的は、V-CurrentとV-Nextの応答を比較し、違いを見つけることです。

- [Diffy](https://github.com/opendiffy/diffy)
- [Envoy](https://www.envoyproxy.io)
- [McRouter](https://github.com/facebook/mcrouter)
- [Scientist](https://github.com/github/scientist)

最も人気のあるツールの1つは[Diffy](https://github.com/opendiffy/diffy)です。Twitterで作成され、使用されました。現在、元の作者と元Twitterの従業員は、 [Opendiffy](https://github.com/opendiffy/diffy)と呼ばれるこのプロジェクトの独自のバージョンを維持しています。Twitterは、エンジニアリングブログで、このツールを「[テストを作成せずにサービスをテストする](https://blog.twitter.com/engineering/en_us/a/2015/diffy-testing-services-without-writing-tests.html)"」と発表しました。

現在、Diffyは、Twitter、Airbnb、Baidu、およびBytedanceの各企業による制作に使用されています。Diffyは、シャドウテスト機能を次のように説明しています。

> Diffyは、新しいコードと古いコードの実行中のインスタンスを並べて使用して、サービスの潜在的なバグを見つけます。Diffyはプロキシとして動作し、受信したすべての要求を実行中の各インスタンスにマルチキャストします。次に、応答を比較し、それらの比較から表面化する可能性のある回帰を報告します。Diffyの前提は、サービスの2つの実装が、十分に大きく多様な要求のセットに対して「類似した」応答を返す場合、2つの実装は同等として扱うことができ、新しい実装はリグレッションフリーであるということです。

![Diffy Shadow Testing Architecture](images/diffy-shadow-testing.png)

上記はDiffyのアーキテクチャです。

## 結論

シャドウテストは、現在の環境を新しい機能を使用して候補環境に置き換えることを検討する場合に、リスクを軽減するための便利なアプローチです。シャドウテストは、本番環境のトラフィックをテスト用の候補環境に複製するため、テスト環境で同じ本番環境のユースケースシナリオを取得できます。両方の環境の違いを比較し、候補環境を検証してリリースの準備を整えることができます。

シャドウテストのいくつかの利点は次のとおりです。

- 実稼働環境への影響はゼロ
- テストシナリオとテストデータを生成する必要はありません
- 実際のデータを使用して、実際のシナリオをテストできます。
- 複製された本番トラフィックでスケールをシミュレートできます。

## 参考文献  

- [マーティンファウラー-ダークローンチング](https://martinfowler.com/bliki/DarkLaunching.html)
- [マーティンファウラー-フィーチャートグル](https://martinfowler.com/bliki/FeatureToggle.html)
- [トラフィックシャドウイング/ミラーリング](https://istio.io/latest/docs/tasks/traffic-management/mirroring/#:~:text=Traffic%20mirroring%2C%20also%20called%20shadowing,path%20for%20the%20primary%20service.)
